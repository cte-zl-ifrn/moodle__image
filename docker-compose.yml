services:
    cache:
        image: redis:7.2-alpine
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 3s
            timeout: 3s
            retries: 3
            start_period: 10s

    db:
        image: postgres:16-alpine
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=changeme
        volumes:
            # init settings, executed only on deploy
            - "./src/postgres/:/docker-entrypoint-initdb.d"
            # database data
            - "~/projetos/IFRN/ava/volumes/db_data:/var/lib/postgresql/data"
        healthcheck:
            test: ["CMD", "pg_isready", "-U", "postgres"]
            interval: 3s
            timeout: 3s
            retries: 3
            start_period: 10s

    nginx:
        image: nginx:1.23.3-alpine
        volumes:
            # confs
            - ./nginx/conf.d:/etc/nginx/conf.d
            - ./nginx/error_pages:/usr/share/nginx/error_pages
        ports:
            - 80:80
        depends_on:
            - moodle

    moodle:
        image: gitlab.ifrn.edu.br:4567/ead/ava/lms/moodle:latest
        build:
            context: ~/projetos/IFRN/ava/lms/moodle
            # additional_contexts:
            #   django-adminlte3: ../django-adminlte3
        environment:
            - POSTGRES_HOST=db
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=changeme
            - CFG_ENV=local
            - CFG_DEBUG=false
            - CFG_WWWROOT=http://ava
            - CFG_ADMINUSER=admin
            - CFG_ADMINPASS=admin
            - CFG_ADMINEMAIL=admin@server.local
            - CFG_FULLNAME=AVA do Campus ZL do IFRN
            - CFG_SHORTNAME=AVA-ZL
            - POSTGRES_DATABASE=postgres
        volumes:
            # Plugins
            - "~/projetos/IFRN/ava/lms/enrol_suap:/var/www/html/enrol/suap"
            - "~/projetos/IFRN/ava/lms/auth_suap:/var/www/html/auth/suap"
            - "~/projetos/IFRN/ava/lms/local_suap:/var/www/html/local/suap"
            - "~/projetos/IFRN/ava/lms/block_suap:/var/www/html/blocks/suap"
            - "~/projetos/IFRN/ava/lms/theme_moove:/var/www/html/theme/moove"
            # - '~/projetos/IFRN/ava/lms/profilefield_json:/var/www/html/user/profile/field/json'
            # - '~/projetos/IFRN/ava/h5p/texteditor/hacks/h5peditor.class.php:/var/www/html/h5p/h5plib/v124/joubel/editor/h5peditor.class.php'
            # - '~/projetos/IFRN/ava/h5p/texteditor/h5peditor-tinymce.js:/var/www/html/h5p/h5plib/v124/joubel/editor/scripts/h5peditor-tinymce.js'
            # Data
            - "~/projetos/IFRN/ava/volumes/moodle_data:/var/moodledata"
        depends_on:
            cache:
                condition: service_healthy
            db:
                condition: service_healthy
